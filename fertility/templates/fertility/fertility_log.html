{% extends 'base.html' %}
{% block title %}Fertility Log{% endblock %}
{% block content %}
<style>
  /* Compact input styling for fertility page */
  input[type="date"],
  input[type="number"],
  input[type="text"],
  textarea {
    max-width: 300px;
    padding: 0.25rem !important;
    font-size: 0.9rem !important;
  }
  
  textarea {
    max-width: 400px;
    min-height: 50px;
    max-height: 80px;
    resize: vertical;
  }
  
  label {
    font-size: 0.85rem !important;
    margin-bottom: 0.1rem !important;
  }
  
  .form-grid > div {
    max-width: 350px;
  }
  
  .fertility-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.5rem;
  }
  
  @media (min-width: 768px) {
    .fertility-layout {
      grid-template-columns: 400px 1fr;
      gap: 0.5rem;
    }
  }
  
  /* Calendar Styles */
  .calendar-container {
    background: white;
    border: 2px solid #4FC3F7;
    border-radius: 0;
    padding: 0.5rem;
  }
  
  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    padding: 0.25rem;
    background: #E1F5FE;
  }
  
  .calendar-header h3 {
    margin: 0;
    font-size: 1rem;
    color: #4FC3F7;
    font-weight: bold;
  }
  
  .calendar-nav {
    display: flex;
    gap: 0.25rem;
  }
  
  .calendar-nav button {
    background: #4FC3F7;
    color: white;
    border: none;
    padding: 0.15rem 0.35rem;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.9rem;
  }
  
  .calendar-nav button:hover {
    background: #81C784;
  }
  
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
  }
  
  .calendar-day-header {
    text-align: center;
    font-weight: bold;
    font-size: 0.75rem;
    padding: 0.25rem;
    background: #E1F5FE;
    color: #4FC3F7;
  }
  
  .calendar-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 1px solid #E0E0E0;
    padding: 0.15rem;
    cursor: pointer;
    background: white;
    font-size: 0.8rem;
    position: relative;
  }
  
  .calendar-day:hover {
    background: #E1F5FE;
  }
  
  .calendar-day.other-month {
    color: #BDBDBD;
    background: #FAFAFA;
  }
  
  .calendar-day.today {
    background: #FFD54F;
    font-weight: bold;
  }
  
  .calendar-day.selected {
    background: #4FC3F7;
    color: white;
    font-weight: bold;
  }
  
  .calendar-day.has-log {
    border: 2px solid #81C784;
    background: #C8E6C9;
  }
  
  .calendar-day.has-log.selected {
    background: #4FC3F7;
    border-color: #81C784;
  }
  
  .day-indicator {
    font-size: 0.6rem;
    position: absolute;
    bottom: 1px;
    color: #81C784;
  }
</style>
<h1 class="card" style="font-size:1.3rem;font-weight:bold;margin-bottom:0.5rem;">Fertility Log</h1>

<div class="fertility-layout">
  <div class="card" style="margin-bottom:0.5rem;">
    <form method="post" id="fertility-form">
      {% csrf_token %}
      <div class="form-section">
        <h2>ðŸŒ¸ Add Fertility Log</h2>
        {{ form.non_field_errors }}
      </div>
      <div class="form-grid">
        <div style="display:none;">
          <label>{{ form.date.label }}</label>
          <input type="hidden" name="date" id="id_date" value="">
        </div>
        <div>
          <label>Selected Date</label>
          <input type="text" id="selected-date-display" readonly value="" style="background:#f5f5f5;cursor:not-allowed;">
        </div>
        <div>
          <label>{{ form.cycle_day.label }}</label>
          {{ form.cycle_day }}
        </div>
        <div>
          <label>{{ form.temperature.label }}</label>
          {{ form.temperature }}
        </div>
        <div class="form-grid-full">
          <label>{{ form.symptoms.label }}</label>
          {{ form.symptoms }}
        </div>
        <div class="form-grid-full">
          <label>{{ form.notes.label }}</label>
          {{ form.notes }}
        </div>
      </div>
      <button type="submit" class="button" style="margin-top:0.5rem;">ðŸ’¾ Add Fertility Log</button>
    </form>
  </div>
  
  <div class="calendar-container">
    <div class="calendar-header">
      <h3 id="calendar-month-year">Month Year</h3>
      <div class="calendar-nav">
        <button type="button" onclick="previousMonth()">â—€</button>
        <button type="button" onclick="nextMonth()">â–¶</button>
      </div>
    </div>
    <div class="calendar-grid">
      <div class="calendar-day-header">Sun</div>
      <div class="calendar-day-header">Mon</div>
      <div class="calendar-day-header">Tue</div>
      <div class="calendar-day-header">Wed</div>
      <div class="calendar-day-header">Thu</div>
      <div class="calendar-day-header">Fri</div>
      <div class="calendar-day-header">Sat</div>
      <div id="calendar-days"></div>
    </div>
  </div>
</div>

<script>
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();
  let selectedDate = null;
  
  // Parse existing logs
  const existingLogs = new Set([
    {% for log in logs %}
    '{{ log.date|date:"Y-m-d" }}',
    {% endfor %}
  ]);
  
  function renderCalendar() {
    const monthNames = ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"];
    
    document.getElementById('calendar-month-year').textContent = 
      monthNames[currentMonth] + ' ' + currentYear;
    
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
    
    const calendarDaysContainer = document.getElementById('calendar-days');
    calendarDaysContainer.innerHTML = '';
    
    const today = new Date();
    const isCurrentMonth = currentMonth === today.getMonth() && currentYear === today.getFullYear();
    
    // Previous month days
    for (let i = firstDay - 1; i >= 0; i--) {
      const day = daysInPrevMonth - i;
      const dayDiv = document.createElement('div');
      dayDiv.className = 'calendar-day other-month';
      dayDiv.textContent = day;
      calendarDaysContainer.appendChild(dayDiv);
    }
    
    // Current month days
    for (let day = 1; day <= daysInMonth; day++) {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'calendar-day';
      dayDiv.textContent = day;
      
      const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      
      if (isCurrentMonth && day === today.getDate()) {
        dayDiv.classList.add('today');
      }
      
      if (existingLogs.has(dateStr)) {
        dayDiv.classList.add('has-log');
        const indicator = document.createElement('div');
        indicator.className = 'day-indicator';
        indicator.textContent = 'âœ“';
        dayDiv.appendChild(indicator);
      }
      
      dayDiv.onclick = function() {
        selectDate(dateStr, this);
      };
      
      calendarDaysContainer.appendChild(dayDiv);
    }
    
    // Next month days
    const totalCells = calendarDaysContainer.children.length;
    const remainingCells = 42 - totalCells; // 6 rows * 7 days
    for (let day = 1; day <= remainingCells; day++) {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'calendar-day other-month';
      dayDiv.textContent = day;
      calendarDaysContainer.appendChild(dayDiv);
    }
  }
  
  function selectDate(dateStr, element) {
    // Remove previous selection
    document.querySelectorAll('.calendar-day.selected').forEach(el => {
      el.classList.remove('selected');
    });
    
    // Add selection to clicked day
    element.classList.add('selected');
    
    selectedDate = dateStr;
    document.getElementById('id_date').value = dateStr;
    document.getElementById('selected-date-display').value = dateStr;
  }
  
  function previousMonth() {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    renderCalendar();
  }
  
  function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    renderCalendar();
  }
  
  // Initialize calendar
  renderCalendar();
  
  // Auto-select today
  const todayStr = new Date().toISOString().split('T')[0];
  selectedDate = todayStr;
  document.getElementById('id_date').value = todayStr;
  document.getElementById('selected-date-display').value = todayStr;
</script>
<div class="card">
  <h2 style="font-size:1.1rem;font-weight:bold;color:#4FC3F7;margin-bottom:0.5rem;">ðŸ“… Your Fertility Logs</h2>
  <div style="overflow-x:auto;">
    <table class="min-w-full table-auto" style="font-size:0.85rem;">
      <thead>
        <tr class="bg-gray-200">
          <th style="padding:0.25rem 0.35rem;">Date</th>
          <th style="padding:0.25rem 0.35rem;">Cycle Day</th>
          <th style="padding:0.25rem 0.35rem;">Temperature</th>
          <th style="padding:0.25rem 0.35rem;">Symptoms</th>
          <th style="padding:0.25rem 0.35rem;">Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr class="border-b">
          <td style="padding:0.25rem 0.35rem;">{{ log.date }}</td>
          <td style="padding:0.25rem 0.35rem;">{{ log.cycle_day }}</td>
          <td style="padding:0.25rem 0.35rem;">{{ log.temperature }}</td>
          <td style="padding:0.25rem 0.35rem;">{{ log.symptoms }}</td>
          <td style="padding:0.25rem 0.35rem;">{{ log.notes }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-center" style="padding:0.35rem;">No fertility logs yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
