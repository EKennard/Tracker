{% extends 'base.html' %}
{% block title %}Fertility Log{% endblock %}
{% block content %}
<style>
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
  }
  
  .calendar-day-header {
    text-align: center;
    font-weight: bold;
    font-size: 0.75rem;
    padding: 0.25rem;
    background: linear-gradient(135deg, #FFF9E6, #FFE5F5);
    color: #FF6F00;
  }
  
  .calendar-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 1px solid #E0E0E0;
    padding: 0.15rem;
    cursor: pointer;
    background: white;
    font-size: 0.8rem;
    position: relative;
  }
  
  .calendar-day:hover {
    background: #F3E5FF;
  }
  
  .calendar-day.other-month {
    color: #BDBDBD;
    background: #FAFAFA;
  }
  
  .calendar-day.today {
    background: #FFD600;
    font-weight: bold;
  }
  
  .calendar-day.selected {
    background: #9C27B0;
    color: white;
    font-weight: bold;
  }
  
  .calendar-day.has-log {
    border: 2px solid #00C853;
    background: #E8F5E9;
  }
  
  .calendar-day.has-log.selected {
    background: #9C27B0;
    border-color: #00C853;
  }
  
  .day-indicator {
    font-size: 0.6rem;
    position: absolute;
    bottom: 1px;
    color: #00C853;
  }
</style>

<h1 class="h4 mb-2" style="color: #9C27B0;">ðŸŒ¸ Fertility Log</h1>

<div class="row g-2">
  <!-- Form Column -->
  <div class="col-lg-4">
    <div class="card" style="border: 2px solid #E91E63;">
      <div class="card-body p-2">
        <h2 class="h5 mb-2" style="color: #E91E63;">Add Fertility Log</h2>
        <form method="post" id="fertility-form">
          {% csrf_token %}
          {{ form.non_field_errors }}
          
          <input type="hidden" name="date" id="id_date" value="">
          
          <div class="mb-2">
            <label for="selected-date-display" class="form-label small">Selected Date</label>
            <input type="text" class="form-control form-control-sm" id="selected-date-display" readonly value="" style="background:#f5f5f5;">
          </div>
          
          <div class="mb-2">
            <label for="{{ form.cycle_day.id_for_label }}" class="form-label small">{{ form.cycle_day.label }}</label>
            {{ form.cycle_day }}
          </div>
          
          <div class="mb-2">
            <label for="{{ form.temperature.id_for_label }}" class="form-label small">{{ form.temperature.label }}</label>
            {{ form.temperature }}
          </div>
          
          <div class="mb-2">
            <label for="{{ form.symptoms.id_for_label }}" class="form-label small">{{ form.symptoms.label }}</label>
            {{ form.symptoms }}
          </div>
          
          <div class="mb-2">
            <label for="{{ form.notes.id_for_label }}" class="form-label small">{{ form.notes.label }}</label>
            {{ form.notes }}
          </div>
          
          <button type="submit" class="btn btn-sm w-100" style="background: linear-gradient(135deg, #9C27B0, #E91E63); color: white; font-weight: bold;">ðŸ’¾ Add Fertility Log</button>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Calendar Column -->
  <div class="col-lg-8">
    <div class="card" style="border: 2px solid #FF6F00;">
      <div class="card-body p-2">
        <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: linear-gradient(135deg, #FFF9E6, #FFE5F5);">
          <h3 class="h6 mb-0" id="calendar-month-year" style="color: #FF6F00;">Month Year</h3>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-sm" style="background: #FF6F00; color: white;" onclick="previousMonth()">â—€</button>
            <button type="button" class="btn btn-sm" style="background: #FF6F00; color: white;" onclick="nextMonth()">â–¶</button>
          </div>
        </div>
        <div class="calendar-grid" id="calendar-grid">
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();
  let selectedDate = null;
  
  // Parse existing logs
  const existingLogs = new Set([
    {% for log in logs %}
    '{{ log.date|date:"Y-m-d" }}',
    {% endfor %}
  ]);
  
  function renderCalendar() {
    const monthNames = ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"];
    
    document.getElementById('calendar-month-year').textContent = 
      monthNames[currentMonth] + ' ' + currentYear;
    
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
    
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '';
    
    const today = new Date();
    const isCurrentMonth = currentMonth === today.getMonth() && currentYear === today.getFullYear();
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(header => {
      const headerDiv = document.createElement('div');
      headerDiv.className = 'calendar-day-header';
      headerDiv.textContent = header;
      calendarGrid.appendChild(headerDiv);
    });
    
    // Previous month days
    for (let i = firstDay - 1; i >= 0; i--) {
      const day = daysInPrevMonth - i;
      const dayDiv = document.createElement('div');
      dayDiv.className = 'calendar-day other-month';
      dayDiv.textContent = day;
      calendarGrid.appendChild(dayDiv);
    }
    
    // Current month days
    for (let day = 1; day <= daysInMonth; day++) {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'calendar-day';
      dayDiv.textContent = day;
      
      const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      
      if (isCurrentMonth && day === today.getDate()) {
        dayDiv.classList.add('today');
      }
      
      if (existingLogs.has(dateStr)) {
        dayDiv.classList.add('has-log');
        const indicator = document.createElement('div');
        indicator.className = 'day-indicator';
        indicator.textContent = 'âœ“';
        dayDiv.appendChild(indicator);
      }
      
      dayDiv.onclick = function() {
        selectDate(dateStr, this);
      };
      
      calendarGrid.appendChild(dayDiv);
    }
    
    // Next month days
    const totalCells = calendarGrid.children.length - 7; // Subtract headers
    const remainingCells = 35 - totalCells; // 5 rows * 7 days
    for (let day = 1; day <= remainingCells; day++) {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'calendar-day other-month';
      dayDiv.textContent = day;
      calendarGrid.appendChild(dayDiv);
    }
  }
  
  function selectDate(dateStr, element) {
    // Remove previous selection
    document.querySelectorAll('.calendar-day.selected').forEach(el => {
      el.classList.remove('selected');
    });
    
    // Add selection to clicked day
    element.classList.add('selected');
    
    selectedDate = dateStr;
    document.getElementById('id_date').value = dateStr;
    document.getElementById('selected-date-display').value = dateStr;
  }
  
  function previousMonth() {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    renderCalendar();
  }
  
  function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    renderCalendar();
  }
  
  // Initialize calendar
  renderCalendar();
  
  // Auto-select today
  const todayStr = new Date().toISOString().split('T')[0];
  selectedDate = todayStr;
  document.getElementById('id_date').value = todayStr;
  document.getElementById('selected-date-display').value = todayStr;
</script>
<div class="card">
  <h2 style="font-size:1.1rem;font-weight:bold;color:#4FC3F7;margin-bottom:0.5rem;">ðŸ“… Your Fertility Logs</h2>
  <div style="overflow-x:auto;">
    <table class="min-w-full table-auto" style="font-size:0.85rem;">
      <thead>
        <tr class="bg-gray-200">
          <th style="padding:0.25rem 0.35rem;">Date</th>
          <th style="padding:0.25rem 0.35rem;">Cycle Day</th>
          <th style="padding:0.25rem 0.35rem;">Temperature</th>
          <th style="padding:0.25rem 0.35rem;">Symptoms</th>
          <th style="padding:0.25rem 0.35rem;">Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr class="border-b">
          <td style="padding:0.25rem 0.35rem;">{{ log.date }}</td>
          <td style="padding:0.25rem 0.35rem;">{{ log.cycle_day }}</td>
          <td style="padding:0.25rem 0.35rem;">{{ log.temperature }}</td>
          <td style="padding:0.25rem 0.35rem;">{{ log.symptoms }}</td>
          <td style="padding:0.25rem 0.35rem;">{{ log.notes }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-center" style="padding:0.35rem;">No fertility logs yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
