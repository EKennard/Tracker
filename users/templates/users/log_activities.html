{% extends 'base.html' %}
{% load static %}
{% block title %}Log Activities{% endblock %}
{% block content %}

<div class="row g-2">
    <!-- LEFT COLUMN: Interactive Calendar -->
    <div class="col-lg-8">
        <div class="card" style="border: 2px solid #9C27B0;">
            <div class="card-body p-3">
                <h2 class="h5 mb-2" style="color: #9C27B0;">üìÖ Select Date to Log Activities</h2>
                <p class="small text-muted">Click a date to view and manage entries for that day</p>
                
                <!-- Calendar will be rendered here -->
                <div id="activityCalendar" class="mb-3"></div>
            </div>
        </div>
    </div>
    
    <!-- RIGHT COLUMN: Date Entries Panel -->
    <div class="col-lg-4">
        <div class="card" style="border: 2px solid #9C27B0;">
            <div class="card-body p-2">
                <h2 class="h5 mb-2" style="color: #9C27B0;" id="entriesDateTitle">üìä Entries for <span id="selectedDateDisplay">{{ selected_date|date:"M d, Y" }}</span></h2>
                
                <!-- Single Add/Edit Button with Dropdown Menu -->
                <div class="dropdown d-grid mb-3">
                    <button class="btn btn-sm" style="background: #9C27B0; color: white;" type="button" id="addEditDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="addEditButtonText">‚ûï Add</span>
                    </button>
                    <ul class="dropdown-menu w-100" aria-labelledby="addEditDropdown">
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#weightModal">
                                ‚öñÔ∏è Weight & Body Stats
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#mealModal">
                                üçé Meal
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#exerciseModal">
                                üí™ Exercise
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#habitModal">
                                ‚úÖ Habit
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#fertilityModal">
                                üå∏ Fertility
                            </a>
                        </li>
                    </ul>
                </div>
                
                <hr>
                
                <!-- Entries for Selected Date -->
                <div id="dateEntriesContainer">
                    <!-- Weight Entry -->
                    <div class="card mb-2" style="border-left: 3px solid #9C27B0;">
                        <div class="card-body p-2">
                            <div class="fw-bold small mb-1" style="color: #9C27B0;">‚öñÔ∏è Weight</div>
                            <div id="weightEntries">
                                {% if recent_weight %}
                                    {% for entry in recent_weight %}
                                        <div class="small">{{ entry.weight_display }}</div>
                                    {% endfor %}
                                {% else %}
                                    <div class="small text-muted fst-italic">No entries</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Meals Entry -->
                    <div class="card mb-2" style="border-left: 3px solid #E91E63;">
                        <div class="card-body p-2">
                            <div class="fw-bold small mb-1" style="color: #E91E63;">üçé Meals</div>
                            <div id="mealEntries">
                                {% if recent_meals %}
                                    {% for meal in recent_meals %}
                                        <div class="small">{{ meal.get_meal_type_display }} - {{ meal.calories }} kcal</div>
                                    {% endfor %}
                                {% else %}
                                    <div class="small text-muted fst-italic">No entries</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exercise Entry -->
                    <div class="card mb-2" style="border-left: 3px solid #FF6F00;">
                        <div class="card-body p-2">
                            <div class="fw-bold small mb-1" style="color: #FF6F00;">üí™ Exercise</div>
                            <div id="exerciseEntries">
                                {% if recent_exercise %}
                                    {% for ex in recent_exercise %}
                                        <div class="small">{{ ex.get_exercise_type_display }} - {{ ex.duration_minutes }} min</div>
                                    {% endfor %}
                                {% else %}
                                    <div class="small text-muted fst-italic">No entries</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Habits Entry -->
                    <div class="card mb-2" style="border-left: 3px solid #FFD600;">
                        <div class="card-body p-2">
                            <div class="fw-bold small mb-1" style="color: #FF9800;">‚úÖ Habits</div>
                            <div id="habitEntries">
                                {% if recent_habits %}
                                    {% for habit in recent_habits %}
                                        <div class="small">{{ habit.habit_name }}</div>
                                    {% endfor %}
                                {% else %}
                                    <div class="small text-muted fst-italic">No entries</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fertility Entry -->
                    <div class="card mb-2" style="border-left: 3px solid #00C853;">
                        <div class="card-body p-2">
                            <div class="fw-bold small mb-1" style="color: #00C853;">üå∏ Fertility</div>
                            <div id="fertilityEntries">
                                {% if recent_fertility %}
                                    {% for fert in recent_fertility %}
                                        <div class="small">Logged</div>
                                    {% endfor %}
                                {% else %}
                                    <div class="small text-muted fst-italic">No entries</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS FOR EACH ACTIVITY TYPE -->

<!-- Weight & Body Stats Modal -->
<div class="modal fade" id="weightModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #9C27B0, #E91E63); color: white;">
                <h5 class="modal-title">‚öñÔ∏è Log Weight & Body Stats</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'log_activities' %}?type=weight" id="weightForm">
                    {% csrf_token %}
                    
                    <!-- Date Field -->
                    <div class="mb-3">
                        <label for="{{ weight_form.date.id_for_label }}" class="form-label">{{ weight_form.date.label }}</label>
                        {{ weight_form.date }}
                        {% if weight_form.date.errors %}
                            <div class="text-danger small">{{ weight_form.date.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Weight Field(s) -->
                    {% if weight_unit == 'st' %}
                        <!-- Stones and Pounds -->
                        <div class="mb-3">
                            <label class="form-label">Weight</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label for="{{ weight_form.weight_stones.id_for_label }}" class="form-label small">Stones</label>
                                    {{ weight_form.weight_stones }}
                                    {% if weight_form.weight_stones.errors %}
                                        <div class="text-danger small">{{ weight_form.weight_stones.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-6">
                                    <label for="{{ weight_form.weight_pounds.id_for_label }}" class="form-label small">Pounds</label>
                                    {{ weight_form.weight_pounds }}
                                    {% if weight_form.weight_pounds.errors %}
                                        <div class="text-danger small">{{ weight_form.weight_pounds.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <small class="form-text text-muted">Enter your weight in stones and pounds (e.g., 12 stones 5 pounds)</small>
                        </div>
                        {{ weight_form.weight }}
                    {% elif weight_unit == 'kg' %}
                        <!-- Kilograms -->
                        <div class="mb-3">
                            <label for="{{ weight_form.weight.id_for_label }}" class="form-label">Weight (kg)</label>
                            {{ weight_form.weight }}
                            {% if weight_form.weight.errors %}
                                <div class="text-danger small">{{ weight_form.weight.errors }}</div>
                            {% endif %}
                        </div>
                        {{ weight_form.weight_stones }}
                        {{ weight_form.weight_pounds }}
                    {% else %}
                        <!-- Pounds -->
                        <div class="mb-3">
                            <label for="{{ weight_form.weight.id_for_label }}" class="form-label">Weight (lb)</label>
                            {{ weight_form.weight }}
                            {% if weight_form.weight.errors %}
                                <div class="text-danger small">{{ weight_form.weight.errors }}</div>
                            {% endif %}
                        </div>
                        {{ weight_form.weight_stones }}
                        {{ weight_form.weight_pounds }}
                    {% endif %}
                    
                    <input type="hidden" name="form_type" value="weight">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="weightForm" class="btn" style="background: #9C27B0; color: white;">üíæ Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Meal Modal -->
<div class="modal fade" id="mealModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #E91E63, #FF6F00); color: white;">
                <h5 class="modal-title">üçé Log Meal</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'log_activities' %}?type=meal" id="mealForm">
                    {% csrf_token %}
                    {{ meal_form.as_p }}
                    <input type="hidden" name="form_type" value="meal">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="mealForm" class="btn" style="background: #E91E63; color: white;">üíæ Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Exercise Modal -->
<div class="modal fade" id="exerciseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #FF6F00, #FFD600); color: white;">
                <h5 class="modal-title">üí™ Log Exercise</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'log_activities' %}?type=exercise" id="exerciseForm">
                    {% csrf_token %}
                    
                    <!-- Date Field -->
                    <div class="mb-3">
                        <label for="{{ exercise_form.date.id_for_label }}" class="form-label">{{ exercise_form.date.label }}</label>
                        {{ exercise_form.date }}
                    </div>
                    
                    <!-- Exercise Type -->
                    <div class="mb-3">
                        <label for="{{ exercise_form.exercise_type.id_for_label }}" class="form-label">{{ exercise_form.exercise_type.label }}</label>
                        {{ exercise_form.exercise_type }}
                    </div>
                    
                    <!-- Duration: Hours and Minutes -->
                    <div class="mb-3">
                        <label class="form-label">Duration</label>
                        <div class="row g-2">
                            <div class="col-6">
                                <label for="{{ exercise_form.duration_hours.id_for_label }}" class="form-label small">Hours</label>
                                {{ exercise_form.duration_hours }}
                            </div>
                            <div class="col-6">
                                <label for="{{ exercise_form.duration_minutes.id_for_label }}" class="form-label small">Minutes</label>
                                {{ exercise_form.duration_minutes }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Distance Logged -->
                    <div class="mb-3">
                        <label for="{{ exercise_form.distance_logged.id_for_label }}" class="form-label">{{ exercise_form.distance_logged.label }}</label>
                        {{ exercise_form.distance_logged }}
                    </div>
                    
                    <!-- Distance Unit -->
                    <div class="mb-3">
                        <label for="{{ exercise_form.distance_unit.id_for_label }}" class="form-label">{{ exercise_form.distance_unit.label }}</label>
                        {{ exercise_form.distance_unit }}
                    </div>
                    
                    <!-- Rating -->
                    <div class="mb-3">
                        <label for="{{ exercise_form.rating.id_for_label }}" class="form-label">{{ exercise_form.rating.label }}</label>
                        {{ exercise_form.rating }}
                    </div>
                    
                    <!-- Intensity -->
                    <div class="mb-3">
                        <label for="{{ exercise_form.intensity.id_for_label }}" class="form-label">{{ exercise_form.intensity.label }}</label>
                        {{ exercise_form.intensity }}
                    </div>
                    
                    <!-- Emoji -->
                    <div class="mb-3">
                        <label for="{{ exercise_form.emoji.id_for_label }}" class="form-label">{{ exercise_form.emoji.label }}</label>
                        {{ exercise_form.emoji }}
                    </div>
                    
                    <!-- Calories Burned -->
                    <div class="mb-3">
                        <label for="{{ exercise_form.calories_burned.id_for_label }}" class="form-label">{{ exercise_form.calories_burned.label }}</label>
                        {{ exercise_form.calories_burned }}
                    </div>
                    
                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="{{ exercise_form.notes.id_for_label }}" class="form-label">{{ exercise_form.notes.label }}</label>
                        {{ exercise_form.notes }}
                    </div>
                    
                    <input type="hidden" name="form_type" value="exercise">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="exerciseForm" class="btn" style="background: #FF6F00; color: white;">üíæ Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Habit Modal -->
<div class="modal fade" id="habitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #FFD600, #00C853); color: white;">
                <h5 class="modal-title">‚úÖ Log Habit</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'log_activities' %}?type=habit" id="habitForm">
                    {% csrf_token %}
                    {{ habit_form.as_p }}
                    <input type="hidden" name="form_type" value="habit">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="habitForm" class="btn" style="background: #FFD600; color: #333;">üíæ Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Fertility Modal -->
<div class="modal fade" id="fertilityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #00C853, #9C27B0); color: white;">
                <h5 class="modal-title">üå∏ Log Fertility</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'log_activities' %}?type=fertility" id="fertilityForm">
                    {% csrf_token %}
                    {{ fertility_form.as_p }}
                    <input type="hidden" name="form_type" value="fertility">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="fertilityForm" class="btn" style="background: #00C853; color: white;">üíæ Save</button>
            </div>
        </div>
    </div>
</div>

<script>
// Calendar implementation with dynamic date selection
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('activityCalendar');
    let currentDate = new Date('{{ selected_date|date:"Y-m-d" }}');
    let selectedDateStr = '{{ selected_date|date:"Y-m-d" }}';
    
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDay = firstDay.getDay();
        
        let html = '<div class="text-center mb-2">';
        html += '<button class="btn btn-sm btn-outline-secondary me-2" onclick="changeMonth(-1)">‚Üê</button>';
        html += '<strong>' + firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) + '</strong>';
        html += '<button class="btn btn-sm btn-outline-secondary ms-2" onclick="changeMonth(1)">‚Üí</button>';
        html += '</div>';
        
        html += '<div class="d-grid" style="grid-template-columns: repeat(7, 1fr); gap: 2px;">';
        
        // Day headers
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            html += `<div class="text-center small fw-bold p-1">${day}</div>`;
        });
        
        // Empty cells before first day
        for (let i = 0; i < startDay; i++) {
            html += '<div></div>';
        }
        
        // Days
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isSelected = dateStr === selectedDateStr;
            const isToday = dateStr === todayStr;
            
            let classes = 'bg-light';
            let style = 'cursor: pointer; border-radius: 4px;';
            
            if (isSelected) {
                classes = 'text-white';
                style += ' background: linear-gradient(135deg, #9C27B0, #E91E63);';
            } else if (isToday) {
                classes = 'border border-primary';
            }
            
            html += `<div class="text-center p-2 ${classes}" style="${style}" onclick="selectDate('${dateStr}')">${day}</div>`;
        }
        
        html += '</div>';
        calendarEl.innerHTML = html;
    }
    
    window.changeMonth = function(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    };
    
    window.selectDate = function(dateStr) {
        // Update the selected date display
        const date = new Date(dateStr + 'T00:00:00');
        const options = { month: 'short', day: 'numeric', year: 'numeric' };
        const formattedDate = date.toLocaleDateString('en-US', options);
        document.getElementById('selectedDateDisplay').textContent = formattedDate;
        
        selectedDateStr = dateStr;
        renderCalendar();
        
        // Load entries for this date via AJAX
        loadEntriesForDate(dateStr);
        
        // Update form dates
        updateFormDates(dateStr);
    };
    
    function loadEntriesForDate(dateStr) {
        // Show loading state
        document.getElementById('dateEntriesContainer').style.opacity = '0.5';
        
        // Fetch entries for the selected date
        fetch(`/users/log/entries/?date=${dateStr}`)
            .then(response => response.json())
            .then(data => {
                updateEntriesDisplay(data);
                document.getElementById('dateEntriesContainer').style.opacity = '1';
            })
            .catch(error => {
                console.error('Error loading entries:', error);
                document.getElementById('dateEntriesContainer').style.opacity = '1';
            });
    }
    
    function updateEntriesDisplay(data) {
        // Check if there are any entries to determine button text
        const hasEntries = (data.weight && data.weight.length > 0) ||
                          (data.meals && data.meals.length > 0) ||
                          (data.exercise && data.exercise.length > 0) ||
                          (data.habits && data.habits.length > 0) ||
                          (data.fertility && data.fertility.length > 0);
        
        // Update button text
        const buttonText = hasEntries ? '‚úèÔ∏è Edit' : '‚ûï Add';
        document.getElementById('addEditButtonText').textContent = buttonText;
        
        // Update Weight
        const weightContainer = document.getElementById('weightEntries');
        if (data.weight && data.weight.length > 0) {
            weightContainer.innerHTML = data.weight.map(w => 
                `<div class="small">${w.weight_display}</div>`
            ).join('');
        } else {
            weightContainer.innerHTML = '<div class="small text-muted fst-italic">No entries</div>';
        }
        
        // Update Meals
        const mealContainer = document.getElementById('mealEntries');
        if (data.meals && data.meals.length > 0) {
            mealContainer.innerHTML = data.meals.map(m => 
                `<div class="small">${m.meal_type} - ${m.calories} kcal</div>`
            ).join('');
        } else {
            mealContainer.innerHTML = '<div class="small text-muted fst-italic">No entries</div>';
        }
        
        // Update Exercise
        const exerciseContainer = document.getElementById('exerciseEntries');
        if (data.exercise && data.exercise.length > 0) {
            exerciseContainer.innerHTML = data.exercise.map(e => 
                `<div class="small">${e.exercise_type} - ${e.duration_minutes} min</div>`
            ).join('');
        } else {
            exerciseContainer.innerHTML = '<div class="small text-muted fst-italic">No entries</div>';
        }
        
        // Update Habits
        const habitContainer = document.getElementById('habitEntries');
        if (data.habits && data.habits.length > 0) {
            habitContainer.innerHTML = data.habits.map(h => 
                `<div class="small">${h.habit_name}</div>`
            ).join('');
        } else {
            habitContainer.innerHTML = '<div class="small text-muted fst-italic">No entries</div>';
        }
        
        // Update Fertility
        const fertilityContainer = document.getElementById('fertilityEntries');
        if (data.fertility && data.fertility.length > 0) {
            fertilityContainer.innerHTML = data.fertility.map(() => 
                `<div class="small">Logged</div>`
            ).join('');
        } else {
            fertilityContainer.innerHTML = '<div class="small text-muted fst-italic">No entries</div>';
        }
    }
    
    function updateFormDates(dateStr) {
        // Update all date inputs in the forms to the selected date
        document.querySelectorAll('input[type="date"]').forEach(input => {
            input.value = dateStr;
        });
    }
    
    renderCalendar();
});
</script>

{% endblock %}
