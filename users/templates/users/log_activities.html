{% extends 'base.html' %}
{% load static %}
{% block title %}Log Activities{% endblock %}
{% block content %}

<div class="row g-2">
    <!-- LEFT COLUMN: Activity Tiles -->
    <div class="col-lg-3">
        <h2 class="h5 mb-2" style="color: #9C27B0;">ğŸ“ Quick Log</h2>
        
        <!-- Weight & Body Stats Tile -->
        <div class="card mb-2" style="border: 2px solid #9C27B0; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#weightModal">
            <div class="card-body p-2 text-center">
                <div class="fs-4">âš–ï¸</div>
                <div class="fw-bold small" style="color: #9C27B0;">Weight & Body Stats</div>
            </div>
        </div>
        
        <!-- Meals Tile -->
        <div class="card mb-2" style="border: 2px solid #E91E63; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#mealModal">
            <div class="card-body p-2 text-center">
                <div class="fs-4">ğŸ</div>
                <div class="fw-bold small" style="color: #E91E63;">Meals</div>
            </div>
        </div>
        
        <!-- Exercise Tile -->
        <div class="card mb-2" style="border: 2px solid #FF6F00; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#exerciseModal">
            <div class="card-body p-2 text-center">
                <div class="fs-4">ğŸ’ª</div>
                <div class="fw-bold small" style="color: #FF6F00;">Exercise</div>
            </div>
        </div>
        
        <!-- Habits Tile -->
        <div class="card mb-2" style="border: 2px solid #FFD600; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#habitModal">
            <div class="card-body p-2 text-center">
                <div class="fs-4">âœ…</div>
                <div class="fw-bold small" style="color: #FF9800;">Habits</div>
            </div>
        </div>
        
        <!-- Fertility Tile -->
        <div class="card mb-2" style="border: 2px solid #00C853; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#fertilityModal">
            <div class="card-body p-2 text-center">
                <div class="fs-4">ğŸŒ¸</div>
                <div class="fw-bold small" style="color: #00C853;">Fertility</div>
            </div>
        </div>
    </div>
    
    <!-- CENTER COLUMN: Interactive Calendar -->
    <div class="col-lg-6">
        <div class="card" style="border: 2px solid #9C27B0;">
            <div class="card-body p-2">
                <h2 class="h5 mb-2" style="color: #9C27B0;">ğŸ“… Select Date</h2>
                <p class="small text-muted">Click a date to log activities for that day</p>
                
                <!-- Calendar will be rendered here -->
                <div id="activityCalendar" class="mb-3"></div>
                
                <div class="alert alert-info mb-0 small">
                    <strong>Selected Date:</strong> <span id="selectedDateDisplay">{{ selected_date|date:"F d, Y" }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- RIGHT COLUMN: Recent Entries Summary -->
    <div class="col-lg-3">
        <h2 class="h5 mb-2" style="color: #9C27B0;">ğŸ“Š Recent Entries</h2>
        
        <!-- Recent Weight -->
        <div class="card mb-2" style="border: 1px solid #9C27B0;">
            <div class="card-body p-2">
                <div class="fw-bold small mb-1" style="color: #9C27B0;">âš–ï¸ Weight</div>
                {% if recent_weight %}
                    {% for entry in recent_weight|slice:":3" %}
                        <div class="small text-muted">{{ entry.date|date:"M d" }}: {{ entry.weight_display }}</div>
                    {% endfor %}
                {% else %}
                    <div class="small text-muted fst-italic">No entries yet</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Meals -->
        <div class="card mb-2" style="border: 1px solid #E91E63;">
            <div class="card-body p-2">
                <div class="fw-bold small mb-1" style="color: #E91E63;">ğŸ Meals</div>
                {% if recent_meals %}
                    {% for meal in recent_meals|slice:":3" %}
                        <div class="small text-muted">{{ meal.date|date:"M d" }}: {{ meal.meal_type }}</div>
                    {% endfor %}
                {% else %}
                    <div class="small text-muted fst-italic">No entries yet</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Exercise -->
        <div class="card mb-2" style="border: 1px solid #FF6F00;">
            <div class="card-body p-2">
                <div class="fw-bold small mb-1" style="color: #FF6F00;">ğŸ’ª Exercise</div>
                {% if recent_exercise %}
                    {% for ex in recent_exercise|slice:":3" %}
                        <div class="small text-muted">{{ ex.date|date:"M d" }}: {{ ex.exercise_type }}</div>
                    {% endfor %}
                {% else %}
                    <div class="small text-muted fst-italic">No entries yet</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- MODALS FOR EACH ACTIVITY TYPE -->

<!-- Weight & Body Stats Modal -->
<div class="modal fade" id="weightModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #9C27B0, #E91E63); color: white;">
                <h5 class="modal-title">âš–ï¸ Log Weight & Body Stats</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/metrics/summary/" id="weightForm">
                    {% csrf_token %}
                    {{ weight_form.as_p }}
                    <input type="hidden" name="metrics_submit" value="1">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="weightForm" class="btn" style="background: #9C27B0; color: white;">ğŸ’¾ Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Meal Modal -->
<div class="modal fade" id="mealModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #E91E63, #FF6F00); color: white;">
                <h5 class="modal-title">ğŸ Log Meal</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/meals/log/" id="mealForm">
                    {% csrf_token %}
                    {{ meal_form.as_p }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="mealForm" class="btn" style="background: #E91E63; color: white;">ğŸ’¾ Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Exercise Modal -->
<div class="modal fade" id="exerciseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #FF6F00, #FFD600); color: white;">
                <h5 class="modal-title">ğŸ’ª Log Exercise</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/exercise/log/" id="exerciseForm">
                    {% csrf_token %}
                    {{ exercise_form.as_p }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="exerciseForm" class="btn" style="background: #FF6F00; color: white;">ğŸ’¾ Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Habit Modal -->
<div class="modal fade" id="habitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #FFD600, #00C853); color: white;">
                <h5 class="modal-title">âœ… Log Habit</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/habits/log/" id="habitForm">
                    {% csrf_token %}
                    {{ habit_form.as_p }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="habitForm" class="btn" style="background: #FFD600; color: #333;">ğŸ’¾ Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Fertility Modal -->
<div class="modal fade" id="fertilityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #00C853, #9C27B0); color: white;">
                <h5 class="modal-title">ğŸŒ¸ Log Fertility</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/fertility/" id="fertilityForm">
                    {% csrf_token %}
                    {{ fertility_form.as_p }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="fertilityForm" class="btn" style="background: #00C853; color: white;">ğŸ’¾ Save</button>
            </div>
        </div>
    </div>
</div>

<script>
// Simple calendar implementation
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('activityCalendar');
    const selectedDate = new Date('{{ selected_date|date:"Y-m-d" }}');
    
    function renderCalendar() {
        const year = selectedDate.getFullYear();
        const month = selectedDate.getMonth();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDay = firstDay.getDay();
        
        let html = '<div class="text-center mb-2">';
        html += '<button class="btn btn-sm btn-outline-secondary me-2" onclick="changeMonth(-1)">â†</button>';
        html += '<strong>' + firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) + '</strong>';
        html += '<button class="btn btn-sm btn-outline-secondary ms-2" onclick="changeMonth(1)">â†’</button>';
        html += '</div>';
        
        html += '<div class="d-grid" style="grid-template-columns: repeat(7, 1fr); gap: 2px;">';
        
        // Day headers
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            html += `<div class="text-center small fw-bold p-1">${day}</div>`;
        });
        
        // Empty cells before first day
        for (let i = 0; i < startDay; i++) {
            html += '<div></div>';
        }
        
        // Days
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isSelected = dateStr === '{{ selected_date|date:"Y-m-d" }}';
            const classes = isSelected ? 'bg-primary text-white' : 'bg-light';
            html += `<div class="text-center p-2 ${classes}" style="cursor: pointer; border-radius: 0;" onclick="selectDate('${dateStr}')">${day}</div>`;
        }
        
        html += '</div>';
        calendarEl.innerHTML = html;
    }
    
    window.changeMonth = function(delta) {
        selectedDate.setMonth(selectedDate.getMonth() + delta);
        renderCalendar();
    };
    
    window.selectDate = function(dateStr) {
        window.location.href = '?date=' + dateStr;
    };
    
    renderCalendar();
});
</script>

{% endblock %}
