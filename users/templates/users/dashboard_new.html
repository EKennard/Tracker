{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<div class="row g-2">
    <!-- LEFT COLUMN: User Stats Card -->
    <div class="col-lg-3">
        <!-- User Card -->
        <div class="card mb-2" style="border: 2px solid #9C27B0;">
            <div class="card-body p-3 text-center">
                <div class="mb-2" style="font-size: 3rem;">
                    {% if profile.avatar == 'male1' %}ğŸ’ª
                    {% elif profile.avatar == 'male2' %}ğŸƒâ€â™‚ï¸
                    {% elif profile.avatar == 'male3' %}ğŸš´â€â™‚ï¸
                    {% elif profile.avatar == 'female1' %}ğŸ’ƒ
                    {% elif profile.avatar == 'female2' %}ğŸƒâ€â™€ï¸
                    {% elif profile.avatar == 'female3' %}ğŸš´â€â™€ï¸
                    {% elif profile.avatar == 'fitness1' %}ğŸ‹ï¸
                    {% elif profile.avatar == 'fitness2' %}ğŸ¤¸
                    {% elif profile.avatar == 'fitness3' %}ğŸ§˜
                    {% elif profile.avatar == 'health1' %}â¤ï¸
                    {% elif profile.avatar == 'health2' %}ğŸŒŸ
                    {% else %}ğŸ‘¤
                    {% endif %}
                </div>
                <h3 class="h6 mb-0">{{ user.username }}</h3>
                <div class="small text-muted mb-3">Member since {{ user.date_joined|date:"M Y" }}</div>
                
                <!-- Quick Stats -->
                <div class="row g-1 text-center small mb-2">
                    <div class="col-4">
                        <div class="fw-bold" style="color: #9C27B0;">{{ activity_count }}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Activities</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold" style="color: #E91E63;">{{ friend_count }}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Friends</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold" style="color: #FF6F00;">{{ milestone_count }}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Milestones</div>
                    </div>
                </div>
                
                <a href="{% url 'profile_view' %}" class="btn btn-sm w-100" style="background: #9C27B0; color: white;">View Profile</a>
            </div>
        </div>
        
        <!-- Weight Summary Card -->
        <div class="card mb-2" style="border: 2px solid #E91E63;">
            <div class="card-body p-2">
                <h3 class="h6 mb-2" style="color: #E91E63;">âš–ï¸ Weight Progress</h3>
                <div class="small mb-1"><strong>Starting:</strong> {{ starting_weight_display }}</div>
                {% if current_weight_display %}
                <div class="small mb-1"><strong>Current:</strong> {{ current_weight_display }}</div>
                <div class="small mb-1"><strong>Lost:</strong> <span style="color: #00C853;">{{ weight_lost }}</span></div>
                {% else %}
                <div class="small text-muted fst-italic">No weight logged yet</div>
                {% endif %}
                {% if current_bmi %}
                <div class="small mb-2"><strong>BMI:</strong> {{ current_bmi|floatformat:1 }}</div>
                {% endif %}
                <a href="{% url 'log_activities' %}" class="btn btn-sm w-100" style="background: #E91E63; color: white;">ğŸ“ Log Weight</a>
            </div>
        </div>
        
        <!-- Weight Chart -->
        <div class="card" style="border: 2px solid #00C853;">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="h6 mb-0" style="color: #00C853;">ğŸ“ˆ Weight Trend</h3>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-success active" data-period="7" onclick="updateChartPeriod(7)">7D</button>
                        <button type="button" class="btn btn-outline-success" data-period="30" onclick="updateChartPeriod(30)">1M</button>
                        <button type="button" class="btn btn-outline-success" data-period="365" onclick="updateChartPeriod(365)">1Y</button>
                    </div>
                </div>
                
                <!-- Mini Chart -->
                <canvas id="miniWeightChart" style="max-height: 150px;"></canvas>
                
                <!-- Progress Bar -->
                {% if weight_progress_percent > 0 %}
                <div class="mt-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small">Progress to Goal</span>
                        <span class="small fw-bold" style="color: #00C853;">{{ weight_progress_percent|floatformat:0 }}%</span>
                    </div>
                    <div class="progress" style="height: 8px; background-color: #F3E5F5;">
                        <div class="progress-bar" role="progressbar" style="width: {{ weight_progress_percent }}%; background: linear-gradient(90deg, #9C27B0, #00C853);"></div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- CENTER COLUMN: Activity Feed -->
    <div class="col-lg-6">
        <div class="card" style="border: 2px solid #9C27B0;">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="h5 mb-0" style="color: #9C27B0;">ğŸ“Š Your Activity Feed</h2>
                    <a href="{% url 'log_activities' %}" class="btn btn-sm" style="background: #9C27B0; color: white;">+ Log New</a>
                </div>
                
                {% if activity_stream %}
                    {% for activity in activity_stream %}
                    <div class="card mb-2" style="border-left: 3px solid 
                        {% if 'Weight' in activity.activity_text or 'Body' in activity.activity_text %}#9C27B0
                        {% elif 'Meal' in activity.activity_text or 'breakfast' in activity.activity_text or 'lunch' in activity.activity_text or 'dinner' in activity.activity_text %}#E91E63
                        {% elif 'Exercise' in activity.activity_text or 'workout' in activity.activity_text %}#FF6F00
                        {% elif 'Habit' in activity.activity_text %}#FFD600
                        {% elif 'Fertility' in activity.activity_text %}#00C853
                        {% else %}#9C27B0
                        {% endif %};">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <span class="fs-5">{{ activity.activity_icon }}</span>
                                        <span class="small fw-bold">{{ activity.activity_text }}</span>
                                    </div>
                                    {% if activity.details %}
                                    <div class="small text-muted ms-4">{{ activity.details }}</div>
                                    {% endif %}
                                </div>
                                <span class="badge bg-light text-dark small">{{ activity.date|date:"M d" }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3" style="font-size: 2.5rem; opacity: 0.3;">ğŸ“Š</div>
                        <p class="text-muted mb-2">No activities logged yet</p>
                        <p class="small text-muted mb-3">Start tracking your wellness journey!</p>
                        <a href="{% url 'log_activities' %}" class="btn btn-sm" style="background: #9C27B0; color: white;">ğŸ“ Log Your First Activity</a>
                        
                        <!-- Quick Start Guide -->
                        <div class="mt-4 text-start">
                            <div class="card mb-2" style="border-left: 3px solid #9C27B0;">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fs-5">âš–ï¸</span>
                                        <div>
                                            <div class="small fw-bold">Track Your Weight</div>
                                            <div class="small text-muted">Monitor your progress over time</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2" style="border-left: 3px solid #E91E63;">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fs-5">ğŸ</span>
                                        <div>
                                            <div class="small fw-bold">Log Your Meals</div>
                                            <div class="small text-muted">Keep track of your nutrition</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2" style="border-left: 3px solid #FF6F00;">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fs-5">ğŸ’ª</span>
                                        <div>
                                            <div class="small fw-bold">Record Workouts</div>
                                            <div class="small text-muted">Track your exercise routine</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2" style="border-left: 3px solid #FFD600;">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fs-5">âœ…</span>
                                        <div>
                                            <div class="small fw-bold">Build Habits</div>
                                            <div class="small text-muted">Create healthy daily routines</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- RIGHT COLUMN: Milestones & Friends -->
    <div class="col-lg-3">
        <!-- Active Milestones -->
        <div class="card mb-2" style="border: 2px solid #FFD600;">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="h6 mb-0" style="color: #FF9800;">ğŸ¯ Milestones</h3>
                    <a href="/milestones/list/" class="btn btn-sm" style="background: #FFD600; color: #333;">View All</a>
                </div>
                
                {% if recent_milestones %}
                    {% for milestone in recent_milestones|slice:":3" %}
                    <div class="border-bottom pb-1 mb-1">
                        <div class="small fw-bold">{{ milestone.title }}</div>
                        <div class="small text-muted">{{ milestone.description|truncatewords:8 }}</div>
                        {% if milestone.date_achieved %}
                        <span class="badge bg-success small">âœ“ Achieved!</span>
                        {% else %}
                        <span class="badge bg-warning text-dark small">In Progress</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted small py-2">
                        No milestones set yet
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Friends Activity -->
        <div class="card" style="border: 2px solid #E91E63;">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="h6 mb-0" style="color: #E91E63;">ğŸ‘¥ Friends</h3>
                    <a href="{% url 'social_hub' %}" class="btn btn-sm" style="background: #E91E63; color: white;">View All</a>
                </div>
                
                {% if friend_activities %}
                    {% for activity in friend_activities|slice:":3" %}
                    <div class="border-bottom pb-1 mb-1">
                        <div class="small"><strong>{{ activity.profile.user.username }}</strong></div>
                        <div class="small text-muted">{{ activity.description|truncatewords:6 }}</div>
                        <div class="small text-muted">{{ activity.created_at|timesince }} ago</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted small py-2">
                        No friend activity yet
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-2" style="border: 2px solid #9C27B0;">
            <div class="card-body p-2">
                <h3 class="h6 mb-2" style="color: #9C27B0;">âš¡ Quick Actions</h3>
                <div class="d-flex flex-column gap-1">
                    <a href="{% url 'log_activities' %}" class="btn btn-sm w-100 text-start" style="background: linear-gradient(135deg, #9C27B0, #E91E63); color: white;">ğŸ“ Log Activities</a>
                    <a href="/milestones/list/" class="btn btn-sm w-100 text-start" style="background: linear-gradient(135deg, #FFD600, #FF9800); color: #333;">ğŸ¯ View Milestones</a>
                    <a href="{% url 'social_hub' %}" class="btn btn-sm w-100 text-start" style="background: linear-gradient(135deg, #E91E63, #9C27B0); color: white;">ğŸ‘¥ Social Hub</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js for mini weight chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const weightData = {{ weight_data_json|safe }};
    let weightChart = null;
    let currentPeriod = 7;
    
    function renderChart(period) {
        if (!weightData || weightData.length === 0) return;
        
        const ctx = document.getElementById('miniWeightChart').getContext('2d');
        
        // Take last N data points based on period
        const recentData = weightData.slice(-period);
        const labels = recentData.map(d => {
            const date = new Date(d.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const weights = recentData.map(d => d.weight);
        
        // Destroy previous chart if exists
        if (weightChart) {
            weightChart.destroy();
        }
        
        weightChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Weight',
                    data: weights,
                    borderColor: '#00C853',
                    backgroundColor: 'rgba(0, 200, 83, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointBackgroundColor: '#00C853',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: { font: { size: 10 } }
                    },
                    x: {
                        ticks: { font: { size: 9 }, maxRotation: 45 }
                    }
                }
            }
        });
    }
    
    function updateChartPeriod(period) {
        currentPeriod = period;
        renderChart(period);
        
        // Update button states
        document.querySelectorAll('[data-period]').forEach(btn => {
            if (parseInt(btn.dataset.period) === period) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
    
    // Initial render
    if (weightData && weightData.length > 0) {
        renderChart(currentPeriod);
    }
</script>

{% endblock %}
