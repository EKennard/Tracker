{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<div class="row g-2">
    <!-- LEFT COLUMN: User Stats Card -->
    <div class="col-lg-3">
        <!-- User Card -->
        <div class="card mb-2">
            <div class="card-body p-3 text-center">
                <h3 class="h6 mb-0">{{ user.username }}</h3>
                <div class="small mb-3">Member since {{ user.date_joined|date:"M Y" }}</div>
                
                <!-- Quick Stats -->
                <div class="row g-1 text-center small mb-2">
                    <div class="col-4">
                        <div class="fw-bold">{{ activity_count }}</div>
                        <div >Activities</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold">{{ friend_count }}</div>
                        <div >Friends</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold">{{ milestone_count }}</div>
                        <div >Milestones</div>
                    </div>
                </div>
                
                <a href="{% url 'profile_view' %}" class="btn btn-sm w-100">View Profile</a>
            </div>
        </div>
        
        <!-- Weight Summary Card -->
        <div class="card mb-2">
            <div class="card-body p-2">
                <h3 class="h6 mb-2">Weight Progress</h3>
                <div class="small mb-1"><strong>Starting:</strong> {{ starting_weight_display }}</div>
                {% if current_weight_display %}
                <div class="small mb-1"><strong>Current:</strong> {{ current_weight_display }}</div>
                <div class="small mb-1"><strong>Lost:</strong> <span>{{ weight_lost }}</span></div>
                {% else %}
                <div class="small fst-italic">No weight logged yet</div>
                {% endif %}
                {% if current_bmi %}
                <div class="small mb-2"><strong>BMI:</strong> {{ current_bmi|floatformat:1 }}</div>
                {% endif %}
                <a href="{% url 'log_activities' %}" class="btn btn-sm w-100">Log Weight</a>
            </div>
        </div>
        
        <!-- Weight Chart -->
        <div class="card">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="h6 mb-0">Weight Trend</h3>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active" data-period="7" onclick="updateChartPeriod(7)">7D</button>
                        <button type="button" class="btn btn-outline-secondary" data-period="30" onclick="updateChartPeriod(30)">1M</button>
                        <button type="button" class="btn btn-outline-secondary" data-period="365" onclick="updateChartPeriod(365)">1Y</button>
                    </div>
                </div>
                
                <!-- Mini Chart -->
                <canvas id="miniWeightChart" style="max-height: 150px;"></canvas>
                
                <!-- Progress Bar -->
                {% if weight_progress_percent > 0 %}
                <div class="mt-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small">Progress to Goal</span>
                        <span class="small fw-bold">{{ weight_progress_percent|floatformat:0 }}%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar" role="progressbar" style="width: {{ weight_progress_percent }}%;"></div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- CENTER COLUMN: Activity Feed -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="h5 mb-0">Your Activity Feed</h2>
                    <a href="{% url 'log_activities' %}" class="btn btn-sm">+ Log New</a>
                </div>
                
                {% if activity_stream %}
                    {% for activity in activity_stream %}
                    <div class="card mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <span class="small fw-bold">{{ activity.activity_text }}</span>
                                    </div>
                                    {% if activity.details %}
                                    <div class="small ms-4">{{ activity.details }}</div>
                                    {% endif %}
                                </div>
                                <span class="badge small">{{ activity.date|date:"M d" }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <p class="mb-2">No activities logged yet</p>
                        <p class="small mb-3">Start tracking your wellness journey!</p>
                        <a href="{% url 'log_activities' %}" class="btn btn-sm">Log Your First Activity</a>
                        
                        <!-- Quick Start Guide -->
                        <div class="mt-4 text-start">
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div>
                                            <div class="small fw-bold">Track Your Weight</div>
                                            <div class="small">Monitor your progress over time</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div>
                                            <div class="small fw-bold">Log Your Meals</div>
                                            <div class="small">Keep track of your nutrition</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div>
                                            <div class="small fw-bold">Record Workouts</div>
                                            <div class="small">Track your exercise routine</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body p-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div>
                                            <div class="small fw-bold">Build Habits</div>
                                            <div class="small">Create healthy daily routines</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- RIGHT COLUMN: Milestones & Friends -->
    <div class="col-lg-3">
        <!-- Active Milestones -->
        <div class="card mb-2">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="h6 mb-0">Milestones</h3>
                    <a href="/milestones/list/" class="btn btn-sm">View All</a>
                </div>
                
                {% if recent_milestones %}
                    {% for milestone in recent_milestones|slice:":3" %}
                    <div class="border-bottom pb-1 mb-1">
                        <div class="small fw-bold">{{ milestone.title }}</div>
                        <div class="small">{{ milestone.description|truncatewords:8 }}</div>
                        {% if milestone.date_achieved %}
                        <span class="badge small">Achieved!</span>
                        {% else %}
                        <span class="badge small">In Progress</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center small py-2">
                        No milestones set yet
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Friends Activity -->
        <div class="card">
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3 class="h6 mb-0">Friends</h3>
                    <a href="{% url 'social_hub' %}" class="btn btn-sm">View All</a>
                </div>
                
                {% if friend_activities %}
                    {% for activity in friend_activities|slice:":3" %}
                    <div class="border-bottom pb-1 mb-1">
                        <div class="small"><strong>{{ activity.profile.user.username }}</strong></div>
                        <div class="small">{{ activity.description|truncatewords:6 }}</div>
                        <div class="small">{{ activity.created_at|timesince }} ago</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center small py-2">
                        No friend activity yet
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-2">
            <div class="card-body p-2">
                <h3 class="h6 mb-2">Quick Actions</h3>
                <div class="d-flex flex-column gap-1">
                    <a href="{% url 'log_activities' %}" class="btn btn-sm w-100 text-start">Log Activities</a>
                    <a href="/milestones/list/" class="btn btn-sm w-100 text-start">View Milestones</a>
                    <a href="{% url 'social_hub' %}" class="btn btn-sm w-100 text-start">Social Hub</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js for mini weight chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const weightData = {{ weight_data_json|safe }};
    const weightUnit = '{{ weight_unit }}';
    const goalWeight = {{ goal_weight_numeric|default:"null" }};
    let weightChart = null;
    let currentPeriod = 7;
    
    function renderChart(period) {
        if (!weightData || weightData.length === 0) return;
        
        const ctx = document.getElementById('miniWeightChart').getContext('2d');
        
        // Calculate date range
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - period + 1);
        
        // Generate all date labels for the period
        const allLabels = [];
        const allWeights = [];
        const currentDate = new Date(startDate);
        
        // Create a lookup map of weight data by date
        const weightByDate = {};
        weightData.forEach(d => {
            weightByDate[d.date] = d.weight;
        });
        
        // Generate data for each day in the period
        while (currentDate <= today) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const label = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            allLabels.push(label);
            // Only add weight if actual entry exists for this date, otherwise null
            allWeights.push(weightByDate[dateStr] !== undefined ? weightByDate[dateStr] : null);
            
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        // Destroy previous chart if exists
        if (weightChart) {
            weightChart.destroy();
        }
        
        // Prepare datasets
        const datasets = [{
            label: 'Weight',
            data: allWeights,
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBorderWidth: 2,
            spanGaps: true,
        }];
        
        // Add goal weight line if it exists
        if (goalWeight !== null) {
            const goalData = allLabels.map(() => goalWeight);
            datasets.push({
                label: 'Goal Weight',
                data: goalData,
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0,
                tension: 0,
            });
        }
        
        weightChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: allLabels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { 
                        display: goalWeight !== null,
                        position: 'top',
                        labels: { 
                            font: { size: 9 },
                            boxWidth: 20
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: { 
                            font: { size: 10 },
                            callback: function(value) {
                                // Format y-axis labels based on unit
                                if (weightUnit === 'st') {
                                    const stones = Math.floor(value);
                                    const pounds = Math.round((value - stones) * 14);
                                    return pounds > 0 ? `${stones}st ${pounds}lb` : `${stones}st`;
                                } else if (weightUnit === 'kg') {
                                    return Math.round(value) + ' kg';
                                } else {
                                    return Math.round(value) + ' lb';
                                }
                            }
                        }
                    },
                    x: {
                        ticks: { font: { size: 9 }, maxRotation: 45 }
                    }
                }
            }
        });
    }
    
    function updateChartPeriod(period) {
        currentPeriod = period;
        renderChart(period);
        
        // Update button states
        document.querySelectorAll('[data-period]').forEach(btn => {
            if (parseInt(btn.dataset.period) === period) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }
    
    // Initial render
    if (weightData && weightData.length > 0) {
        renderChart(currentPeriod);
    }
</script>

{% endblock %}
