{% extends 'base.html' %}
{% block title %}Edit Profile{% endblock %}
{% block content %}

<div class="row g-2 justify-content-center">
  <div class="col-lg-8">
    <div class="card mb-2">
      <div class="card-body p-2">
        <h3 class="h6 mb-2">Edit Profile</h3>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    {% if form.errors %}
    <div class="alert alert-secondary p-2 mb-2">
      <div class="small fw-bold mb-1">Form Errors:</div>
      {{ form.non_field_errors }}
      {% for field in form %}
        {% if field.errors %}
          <div class="small mb-1">
            <strong>{{ field.label }}:</strong> {{ field.errors|join:", " }}
          </div>
        {% endif %}
      {% endfor %}
    </div>
    {% endif %}
    
    <!-- Basic Information -->
    <div class="mb-2">
      <div class="small fw-bold mb-2">Basic Information</div>
    </div>
    <div class="row g-2 mb-2">
      <div class="col-md-4">
        <label class="form-label small mb-1">Date of Birth *</label>
        {{ form.date_of_birth }}
      </div>
      <div class="col-md-4">
        <label class="form-label small mb-1">Sex *</label>
        {{ form.sex }}
      </div>
      <div class="col-md-4">
        <label class="form-label small mb-1">Activity Level *</label>
        {{ form.activity_level }}
      </div>
    </div>
    
    <!-- Unit Preferences -->
    <div class="mb-2 mt-2">
      <div class="small fw-bold mb-2">Unit Preferences</div>
    </div>
    
    <div class="mb-2">
      <label class="form-label small mb-1">Weight Unit *</label>
      <div class="btn-group btn-group-sm w-100" role="group">
        <button type="button" class="btn btn-outline-secondary unit-option" data-unit="kg" onclick="setWeightUnit('kg')" >Kilograms (kg)</button>
        <button type="button" class="btn btn-outline-secondary unit-option" data-unit="lb" onclick="setWeightUnit('lb')" >Pounds (lb)</button>
        <button type="button" class="btn btn-outline-secondary unit-option" data-unit="st" onclick="setWeightUnit('st')" >Stones (st)</button>
      </div>
      <div class="d-none">{{ form.weight_unit }}</div>
    </div>
    
    <div class="mb-2">
      <label class="form-label small mb-1">Starting Weight *</label>
      
      <div id="weight-kg" class="weight-input" style="display:none;">
        <div class="input-group input-group-sm">
          <input type="number" step="0.01" class="form-control" id="weight-input-kg" placeholder="Enter weight">
          <span class="input-group-text">kg</span>
        </div>
      </div>
      
      <div id="weight-lb" class="weight-input" style="display:none;">
        <div class="input-group input-group-sm">
          <input type="number" step="0.01" class="form-control" id="weight-input-lb" placeholder="Enter weight">
          <span class="input-group-text">lb</span>
        </div>
      </div>
      
      <div id="weight-st" class="weight-input" style="display:none;">
        <div class="row g-1">
          <div class="col">
            <div class="input-group input-group-sm">
              <input type="number" class="form-control" id="weight-stones-input" placeholder="Stones">
              <span class="input-group-text">st</span>
            </div>
          </div>
          <div class="col">
            <div class="input-group input-group-sm">
              <input type="number" step="0.1" class="form-control" id="weight-pounds-input" placeholder="Pounds">
              <span class="input-group-text">lb</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="mb-2">
      <label class="form-label small mb-1">Height Unit *</label>
      <div class="btn-group btn-group-sm w-100" role="group">
        <button type="button" class="btn btn-outline-secondary unit-option" data-unit="cm" onclick="setHeightUnit('cm')" >Centimeters (cm)</button>
        <button type="button" class="btn btn-outline-secondary unit-option" data-unit="in" onclick="setHeightUnit('in')" >Feet/Inches (ft/in)</button>
      </div>
      <div class="d-none">{{ form.height_unit }}</div>
    </div>
    
    <div class="mb-2">
      <label class="form-label small mb-1">Height *</label>
      
      <div id="height-cm" class="height-input" style="display:none;">
        <div class="input-group input-group-sm">
          <input type="number" step="0.01" class="form-control" id="height-input-cm" placeholder="Enter height">
          <span class="input-group-text">cm</span>
        </div>
      </div>
      
      <div id="height-in" class="height-input" style="display:none;">
        <div class="row g-1">
          <div class="col">
            <div class="input-group input-group-sm">
              <input type="number" class="form-control" id="height-feet-input" placeholder="Feet">
              <span class="input-group-text">ft</span>
            </div>
          </div>
          <div class="col">
            <div class="input-group input-group-sm">
              <input type="number" step="0.1" class="form-control" id="height-inches-input" placeholder="Inches">
              <span class="input-group-text">in</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="mb-2">
      <label class="form-label small mb-1">Distance Unit *</label>
      <div class="btn-group btn-group-sm w-100" role="group">
        <button type="button" class="btn btn-outline-secondary unit-option" data-unit="km" onclick="setDistanceUnit('km')" >Kilometres (km)</button>
        <button type="button" class="btn btn-outline-secondary unit-option" data-unit="mi" onclick="setDistanceUnit('mi')" >Miles (mi)</button>
      </div>
      <div class="d-none">{{ form.distance_unit }}</div>
    </div>
    
    <!-- Goals (Optional) -->
    <div class="mb-2 mt-2">
      <div class="small fw-bold mb-2">Goals (Optional)</div>
    </div>
    <div class="row g-2 mb-2">
      <div class="col-12">
        <label class="form-label small mb-1">Goal Description</label>
        {{ form.goal }}
      </div>
      <div class="col-md-6">
        <label class="form-label small mb-1">Goal Deadline</label>
        {{ form.deadline }}
      </div>
    </div>
    
    <!-- Privacy Settings -->
    <div class="mb-2 mt-2">
      <div class="small fw-bold mb-2">Privacy Settings</div>
    </div>
    <div class="mb-2">
      <div class="form-check">
        {{ form.is_public }}
        <label class="form-check-label small" for="{{ form.is_public.id_for_label }}">
          Make my profile public (allow others to view my progress)
        </label>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="d-flex gap-2 justify-content-center mt-2">
      <a href="/users/profile/" class="btn btn-secondary btn-sm">Cancel</a>
      <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
    </div>
  </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Initialize with current profile values
  const initialWeightUnit = '{{ form.weight_unit.value }}' || 'kg';
  const initialHeightUnit = '{{ form.height_unit.value }}' || 'cm';
  const initialDistanceUnit = '{{ form.distance_unit.value }}' || 'km';
  
  // Pre-fill values if editing
  const weightKgValue = {{ weight_kg_value|default:"null" }};
  const weightLbValue = {{ weight_lb_value|default:"null" }};
  const weightStonesValue = {{ weight_stones_value|default:"null" }};
  const weightPoundsValue = {{ weight_pounds_value|default:"null" }};
  const heightCmValue = {{ height_cm_value|default:"null" }};
  const heightFeetValue = {{ height_feet_value|default:"null" }};
  const heightInchesValue = {{ height_inches_value|default:"null" }};
  
  // Weight unit toggle
  function setWeightUnit(unit) {
    document.querySelector('select[name="weight_unit"]').value = unit;
    
    // Update button styles
    document.querySelectorAll('.unit-option[data-unit]').forEach(btn => {
      if (btn.getAttribute('onclick')?.includes('setWeightUnit')) {
        if (btn.dataset.unit === unit) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      }
    });
    
    // Show/hide appropriate input
    document.querySelectorAll('.weight-input').forEach(div => div.style.display = 'none');
    
    const kgInput = document.getElementById('weight-input-kg');
    const lbInput = document.getElementById('weight-input-lb');
    const stonesInput = document.getElementById('weight-stones-input');
    const poundsInput = document.getElementById('weight-pounds-input');
    
    // Clear all name attributes
    kgInput.removeAttribute('name');
    lbInput.removeAttribute('name');
    stonesInput.removeAttribute('name');
    poundsInput.removeAttribute('name');
    
    if (unit === 'kg') {
      document.getElementById('weight-kg').style.display = 'block';
      kgInput.name = 'starting_weight';
    } else if (unit === 'lb') {
      document.getElementById('weight-lb').style.display = 'block';
      lbInput.name = 'starting_weight';
    } else if (unit === 'st') {
      document.getElementById('weight-st').style.display = 'block';
      stonesInput.name = 'weight_stones';
      poundsInput.name = 'weight_pounds_extra';
    }
  }
  
  // Height unit toggle
  function setHeightUnit(unit) {
    document.querySelector('select[name="height_unit"]').value = unit;
    
    // Update button styles
    document.querySelectorAll('.unit-option[data-unit]').forEach(btn => {
      if (btn.getAttribute('onclick')?.includes('setHeightUnit')) {
        if (btn.dataset.unit === unit) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      }
    });
    
    // Show/hide appropriate input
    document.querySelectorAll('.height-input').forEach(div => div.style.display = 'none');
    
    const cmInput = document.getElementById('height-input-cm');
    const feetInput = document.getElementById('height-feet-input');
    const inchesInput = document.getElementById('height-inches-input');
    
    // Clear all name attributes
    cmInput.removeAttribute('name');
    feetInput.removeAttribute('name');
    inchesInput.removeAttribute('name');
    
    if (unit === 'cm') {
      document.getElementById('height-cm').style.display = 'block';
      cmInput.name = 'height';
    } else if (unit === 'in') {
      document.getElementById('height-in').style.display = 'block';
      feetInput.name = 'height_feet';
      inchesInput.name = 'height_inches';
    }
  }
  
  // Distance unit toggle
  function setDistanceUnit(unit) {
    document.querySelector('select[name="distance_unit"]').value = unit;
    
    // Update button styles
    document.querySelectorAll('.unit-option[data-unit]').forEach(btn => {
      if (btn.getAttribute('onclick')?.includes('setDistanceUnit')) {
        if (btn.dataset.unit === unit) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      }
    });
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Set initial units
    setWeightUnit(initialWeightUnit);
    setHeightUnit(initialHeightUnit);
    setDistanceUnit(initialDistanceUnit);
    
    // Pre-fill values
    if (weightKgValue) document.getElementById('weight-input-kg').value = weightKgValue;
    if (weightLbValue) document.getElementById('weight-input-lb').value = weightLbValue;
    if (weightStonesValue) document.getElementById('weight-stones-input').value = weightStonesValue;
    if (weightPoundsValue) document.getElementById('weight-pounds-input').value = weightPoundsValue;
    if (heightCmValue) document.getElementById('height-input-cm').value = heightCmValue;
    if (heightFeetValue) document.getElementById('height-feet-input').value = heightFeetValue;
    if (heightInchesValue) document.getElementById('height-inches-input').value = heightInchesValue;
  });
  
  // Calculate and display age from date of birth
  const dobInput = document.querySelector('input[name="date_of_birth"]');
  if (dobInput) {
    dobInput.addEventListener('change', function() {
      const dob = new Date(this.value);
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      const monthDiff = today.getMonth() - dob.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
        age--;
      }
      if (age >= 0 && age < 120) {
        const ageDisplay = document.createElement('div');
        ageDisplay.style.cssText = 'margin-top:0.5rem;color:#81C784;font-size:0.9rem;';
        ageDisplay.textContent = `Age: ${age} years`;
        // Remove existing age display if any
        const existing = this.parentElement.querySelector('.age-display');
        if (existing) existing.remove();
        ageDisplay.className = 'age-display';
        this.parentElement.appendChild(ageDisplay);
      }
    });
  }
</script>

{% endblock %}
